---
title: "rat-tici-secretome"
author: "pp"
date: "4/7/2022"
output: pdf_document
---
The goal of this project is to analyze the data from the proteomics study of TICI-treated rat astrocytes. There are 5 samples (biological replicates) corresponding to TICI-treated astrocytes and 5 samples that are Vehicle-treated astrocytes. A total of 1596 proteins were identified. VEH2 sample was excluded due to having low ion intensities (probably due to low cell count) making it a total of 9 samples including both TICI and Veh.

Calling all the packages
```{r}
library(dplyr)
library(tidyverse)
library(edgeR)
library(ggfortify)
library(plyr)
library(ggplot2)
library(scales)
library(grid)
library(pheatmap)
library(RColorBrewer)
library(ggeasy)
library(EnhancedVolcano)
library(ggrepel)
```

Calling the ggbiplot_script
```{r}
source("ggbiplot_script.R")
```

Loading data from the secretome proteomics raw tmt output file.
```{r}
protein_groups <- read_csv("../data/rat_tici_secretome.csv")
protein_groups_tmt <- protein_groups %>%
  select(protein_ids = 'gene_names',
         TICI1 = 'tici_1',
         TICI2 = 'tici_2',
         TICI3 = 'tici_3',
         TICI4 = 'tici_4',
         TICI5 = 'tici_5',
         VEH1 = 'veh_1',
         VEH2 = 'veh_2',
         VEH3 = 'veh_3',
         VEH4 = 'veh_4',
         VEH5 = 'veh_5'
  )
```
Check if the data follows a negative binomial distribution.
```{r}
intensity.plot <- protein_groups_tmt %>%
  ggplot() +
  geom_histogram(aes(TICI1, fill = "TICI", color = "1"), bins = 100) +
  geom_histogram(aes(TICI2, fill = "TICI", color = "2"), bins = 100) +
  geom_histogram(aes(TICI3, fill = "TICI", color = "3"), bins = 100) +
  geom_histogram(aes(TICI4, fill = "TICI", color = "4"), bins = 100) +
  geom_histogram(aes(TICI5, fill = "TICI", color = "5"), bins = 100) +
  geom_histogram(aes(VEH1, fill = "VEH", color = "1"), bins = 100) +
  geom_histogram(aes(VEH2, fill = "VEH", color = "2"), bins = 100) +
  geom_histogram(aes(VEH3, fill = "VEH", color = "3"), bins = 100) +
  geom_histogram(aes(VEH4, fill = "VEH", color = "4"), bins = 100) +
  geom_histogram(aes(VEH5, fill = "VEH", color = "5"), bins = 100) +
  scale_y_continuous(trans = "log1p") +
  labs(title="Distribution of ion intensity",x="TMT intensity", y = "Count")
```

Creating the initial edgeR object with all the TMT values from each sample group. Here I will analyze the DE proteins in TICI vs. VEH samples.
```{r}
groups = c("TICI", "TICI", "TICI", "TICI", "TICI", "VEH", "VEH", "VEH", "VEH", "VEH") %>%
  factor(levels = c("TICI", "VEH"))
design = model.matrix(~0+groups)
contrasts = makeContrasts(
  H = groupsTICI - groupsVEH,
  levels = design
)
TMT_edgeR <- DGEList(
  counts = protein_groups_tmt %>%
    mutate(protein_ids = make.unique(protein_ids)) %>%
    na.omit() %>%
    column_to_rownames("protein_ids"),
  group = c(1,1,1,1,1,2,2,2,2,2)
)
```

Filtering out rows so that each row has at least 9 non-zero values.
```{r}
TMT_edgeR_9 <- TMT_edgeR[rowSums(cpm(TMT_edgeR) == 0) <= (9-9) , ]
TMT_edgeR_9 <- TMT_edgeR_9 %>% calcNormFactors()
TMT_edgeR_9 <- TMT_edgeR_9 %>% estimateGLMCommonDisp(design=design)
lrt_TMT_9 <- glmLRT(glmFit(TMT_edgeR_9, design), contrast = contrasts) %>% decideTestsDGE(p.value = 0.05)
plotSmear(TMT_edgeR_9, de.tags = rownames(lrt_TMT_9)[lrt_TMT_9 %>% as.logical()], main = 'MA plot for count data')
abline(h=c(-1,1), col='blue')

#new analysis added
de <- exactTest(TMT_edgeR_9)
de.proteins <- row.names(topTags(de, n=500)$table)
plotSmear(TMT_edgeR_9, de.tags=de.proteins, main='Top 500 proteins')
```

Making the PCA plot
```{r}
make_pca_plot <- function(tp, tp_edger, ellipse = TRUE) {
  tp %>%
    na.omit %>%
    filter(protein_ids %in% tp_edger) %>%
    column_to_rownames("protein_ids") %>%
    as.matrix() %>%
    t %>%
    prcomp(center = T, scale = T) %>%
    ggbiplot(labels = c("TICI1", "TICI2", "TICI3", "TICI4", "TICI5", "VEH1", "VEH2", "VEH3", "VEH4", "VEH5"),
             groups = c("TICI", "TICI", "TICI", "TICI", "TICI", "VEH", "VEH", "VEH", "VEH", "VEH"),
             ellipse = ellipse)+
    theme_classic()
  }
```

View the PCA plot
```{r}
pca.plot <- protein_groups_tmt %>%
  make_pca_plot(tp_edger = rownames(lrt_TMT_9)[as.logical(lrt_TMT_9)]) +
  ggtitle("TICI astrocyte secretome")
ggeasy::easy_center_title()
```

The PC1 and PC2 separate very well and explain the variation in ~85% of the data. Now I will create the tables.
```{r}
table_TMT_edgeR <- (glmLRT(glmFit(TMT_edgeR_9, design), contrast = contrasts) %>% 
                      topTags(n=2000))$table %>%
  rownames_to_column("gene_names") %>%
  as_tibble() %>%
  merge(protein_groups %>%
          mutate(`gene_names` = 
                   make.unique(`gene_names`))) %>%
  as_tibble() %>%
  arrange(FDR)

write.table(table_TMT_edgeR, file = "../data/results_secretome.csv", sep = ",", row.names = FALSE)
```

Making heatmap by calculating Z-scores with the scale function
```{r}
df <- read.csv('../data/results_secretome.csv')
#df <- df[1:63, ]

log10.intensity.df = df %>% mutate(proteins = make.unique(gene_names)) %>%
  #filter(FDR<0.1) %>%
  select(-logFC,	-logCPM,	-LR,	-PValue,	-FDR,	-p_value,	-difference, -tici_veh, -neg_log_pvalue,  -peptides,	-percent_sequence_coverage,	-mol_wt_kda,	-score,	-intensity,	-ibaq, -protein_names, -protein_ids, -ms_ms_count) %>%
  mutate(mean1 = mean(c(tici_1, tici_2, tici_3, tici_4, tici_5, veh_1, veh_2, veh_3, veh_4, veh_5))) %>%
  mutate_if(is.numeric, log10)

log10.intensity.df[,2:28] = t(scale(t(log10.intensity.df[,2:28])))

rownames(log10.intensity.df) = log10.intensity.df$proteins

log10.intensity.df = log10.intensity.df[,2:28]

heat.map <- log10.intensity.df %>% as.matrix() %>%
  pheatmap::pheatmap(color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
                     main = "TICI Astrocyte Secretome DE Proteins",
                     cluster_rows = TRUE,
                     cluster_cols = TRUE, breaks = seq(-2, 2, length.out=100), legend = TRUE, legend_breaks = NA, legend_labels = NA, annotation = NA, annotation_colors = NA, annotation_legend = TRUE, fontsize = 10, fontsize_row = 10)
```